---
title: "Vans1 Nav and PDP"
author: "David Bricker"
date: "2025-08-05"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r}
###################################################################################
# General Setup
###################################################################################

knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(janitor)
library(lubridate)
library(scales)
# library(readxl)
# library(RSQLite)
#library(rJava)
#library(RJDBC)
# library(data.table)
# library(prophet)
# #library(kableExtra)
# library(rstatix)
# library(BSDA)
# library(effectsize)

###################################################################################
# Set Plot Theme
###################################################################################

vf_theme <- theme(
  plot.margin = unit(rep(1, 4), "cm"),
  text = element_text(family = "sans"),
  plot.title = element_text(
    size = 24,
    face = "bold",
    color = "#004C97",
    margin = margin(b = 0)
  ),
  plot.subtitle = element_text(
    size = 16,
    lineheight = 1.1,
    color = "#222222",
    margin = margin(b = 25)
  ),
  plot.caption = element_text(
    size = 12,
    margin = margin(t = 25),
    color = "#004C97"
  ),
  axis.title.x = element_text(margin = margin(t = 15), color = "#004C97"),
  axis.title.y = element_text(margin = margin(r = 15), color = "#004C97"),
  axis.text = element_text(color = "#004C97"),
  axis.line = element_line(color = "#004C97"),
  panel.grid.minor = element_blank(),
  panel.grid.major = element_line(color = "#9BB8D3", size = .001),
  panel.background = element_rect(fill = "#ffffff", color = "#ffffff"),
  legend.position = "bottom",
  legend.text = element_text(color = "#004C97"),
  legend.title = element_text(color = "#222222")
)

set_vf_theme <- function() {
  theme_set(
    theme_minimal(base_size = 18) +
      vf_theme
  )
}
set_vf_theme()

###################################################################################
# Create VF Color Scheme Palettes and Functions
###################################################################################

vf_colors <- c(
  `heritage blue` = "#004C97",
  `glacier blue` = "#9BB8D3",
  `stone` = "#DBE2E9",
  `vf black` = "#222222",
  `vivid teal` = "#41B6E6",
  `garden green` = "#00B388",
  `royal` = "#7D55C7"
)

vf_cols <- function(...) {
  cols <- c(...)

  if (is.null(cols)) {
    return(vf_colors)
  }

  vf_colors[cols]
}

vf_palette <- list(
  `all` = vf_cols(
    "heritage blue",
    "glacier blue",
    "stone",
    "vf black",
    "vivid teal",
    "garden green",
    "royal"
  ),
  `main3` = vf_cols("heritage blue", "glacier blue", "stone"),
  `dark` = vf_cols(
    "heritage blue",
    "glacier blue",
    "vf black",
    "vivid teal",
    "garden green",
    "royal"
  ),
  `two` = vf_cols("heritage blue", "glacier blue")
)

vf_pal <- function(palette = "main", atcerse = FALSE, ...) {
  pal <- vf_palette[[palette]]

  if (atcerse) {
    pal <- atc(pal)
  }

  colorRampPalette(pal, ...)
}

scale_color_vf <- function(
  palette = "main",
  discrete = TRUE,
  atcerse = FALSE,
  ...
) {
  pal <- vf_pal(palette = palette, atcerse = atcerse)

  if (discrete) {
    discrete_scale("color", paste0("vf", palette), palette = pal, ...)
  } else {
    scale_color_gradientn(colours = pal(256), ...)
  }
}


scale_fill_vf <- function(
  palette = "main",
  discrete = TRUE,
  atcerse = FALSE,
  ...
) {
  pal <- vf_pal(palette = palette, atcerse = atcerse)

  if (discrete) {
    discrete_scale("fill", paste0("vf", palette), palette = pal, ...)
  } else {
    scale_fill_gradientn(colours = pal(256), ...)
  }
}

```

# BQ Connection

```{r}
#  sw_conn <- dbConnect(
#      bigrquery::bigquery(),
#      project = "bigquery-smartwool",
#      dataset = "bigquery-smartwool.analytics_255598975")
#  )
#
# altra_conn <- dbConnect(
#      bigrquery::bigquery(),
#      project = "bigquery-altra",
#      dataset = "bigquery-altra.analytics_269104366")
#  )

# dck_con <- dbConnect(
#     bigrquery::bigquery(),
#     project = "bigquery-dickies-us",
#     dataset = "bigquery-dickies-us.analytics_2548082672")

# tnf_con <- dbConnect(
#     bigrquery::bigquery(),
#     project = "nora-tnf-232219",
#     dataset = "nora-tnf-232219.analytics_254456401")

# tbl_con <- dbConnect(
#     bigrquery::bigquery(),
#     project = "bigquery-tbl-us",
#     dataset = "analytics_254489026")

# vans_con <- dbConnect(
#   bigrquery::bigquery(),
#   project = "vans-family-app-us---prod",
#   dataset = "analytics_253994679"
# )
```

# Query/Read In Data - Cart Order Summary TBL

```{r}
# Required libraries and Read in Data

library(tidyverse)
library(janitor)
library(lubridate)
library(scales)

vans1 <- read.csv("C:/Users/brick/Documents/saga/blog/nav_and_pdp/cleaned.csv")


```

# Nav and PDP Data Cleaning
```{r}
# Clean up some ambiguous variables and filter out sessions that opted out of tracking
cleaned_df <- vans1 |>
  filter(!is.na(session_id)) |>
  mutate(
    device = case_when(device == "desktop" ~ "Desktop", TRUE ~ "Mobile"),
    new_returning = case_when(session_num > 1 ~ "Returning", TRUE ~ "New"),
    nav_flag = case_when(
      nav_clicks >= 1 ~ "Used Nav",
      TRUE ~ "Did Not Use Nav"
    ),
    pdp_view = case_when(
      pdp_flag >= 1 ~ "Viewed PDP",
      TRUE ~ "Did Not View PDP"
    )
  )
# |>
#   mutate(mean_rev = mean(revenue[purchase >=1]),
#          z_score_rev = scale(revenue),
#          u_iqr2_rev = mean(revenue[purchase >=1]) + 2*IQR(revenue[purchase >= 1]),
# l_iqr2_rev = mean(revenue[purchase >=1]) - 2*IQR(revenue[purchase >= 1]),
# outlier_rev = !between(revenue, l_iqr2_rev,u_iqr2_rev),
# outlier_rev = revenue > u_iqr2_rev
#        ) |>
# filter(outlier_rev == FALSE)
```

# Stratified Sampling
```{r}
# Check distribution of channels and landing page categories

cleaned_df|>
  group_by(test_group,
           channel,
           landing_page_cat) |>
  summarize(
    sessions = n_distinct(session_id),
    cvr = sum(purchase) / sessions
  ) |>
  ggplot(aes(reorder(landing_page_cat, sessions), sessions, fill = test_group), ) +
  scale_y_continuous(labels = comma) +
  geom_col(position = "dodge") +
  facet_wrap(~channel) +
  scale_fill_vf(palette = "two") +
  coord_flip() +
  labs(x = "Landing Page",
       y = "Sessions",
       fill = NULL)

# Create data frame with total counts of sessions for each channel-landing page category by test group. 
# Add a column with the minimum number of sessions for each landing page category between test and control. Finally filter out any categories with
# 0 sessions in one group

sessions <- cleaned_df |>
  group_by(test_group, 
           channel,
           landing_page_cat) |>
  summarize(
    sessions = n_distinct(session_id)) |>
  pivot_wider(
    id_cols =  c(landing_page_cat, channel),
    names_from = test_group,
    values_from = sessions
  ) |>
  rowwise() |>
  mutate(min = min(c(Control, Test))) |> 
  filter(!is.na(min))

# Join the minimum session counts column to the original data frame.
# Resample test and control groups so that each channel-landing page 
# combination has an equal number of observations between test and control.
# Equal to the "min" column.


cleaned_strat <- cleaned_df |>
  left_join(sessions |> select(landing_page_cat, channel, min), by = c("landing_page_cat", "channel")) |>
  filter(!is.na(min)) |> 
  group_by(test_group, channel, landing_page_cat) |>
  sample_n(min(min))|>
  mutate(test_group = factor(test_group),
         purchase = as.numeric(purchase))

# Chart to check that session counts by landing page are equal between test
# and control

cleaned_strat |>
  group_by(landing_page_cat, channel, test_group) |>
  summarize(sessions = n_distinct(session_id))|> 
  ggplot(aes(reorder(landing_page_cat, sessions), sessions, fill = test_group), ) +
  scale_y_continuous(labels = comma) +
  geom_col(position = "dodge") +
  scale_fill_vf(palette = "two") +
  coord_flip() +
  facet_wrap(~channel) +
  labs(x = NULL,
       y = "Sessions",
       fill = NULL)

# Summarize test and control groups

cleaned_summary <- cleaned_strat |>
  filter(tracking_consent == 1) |>
  group_by(test_group, ) |>
  summarize(
    sessions = n_distinct(session_id),
    added_to_cart = sum(add_to_cart),
    purchases = sum(purchase, na.rm = TRUE),
    purchase_quantity = sum(quantity, na.rm = TRUE),
    total_revenue = sum(revenue, na.rm = TRUE),
    plp_views = sum(plp_flag),
    pdp_views = sum(pdp_flag),
    nav_clicks = sum(nav_clicks),
    bounced_sessions = sum(bounced_flag)
  ) |>
  mutate(
    cvr = purchases / sessions,
    atc_per_session = added_to_cart / sessions,
    aov = total_revenue / purchases,
    items_per_transaction = purchase_quantity / purchases,
    rev_per_session = total_revenue / sessions,
    nav_clicks_per_session = nav_clicks / sessions,
    plps_per_session = plp_views / sessions,
    pdps_per_session = pdp_views / sessions,
    bounce_rate = bounced_sessions / sessions,
    test_group = factor(test_group, levels = c("Test", "Control"))
  )

# Create data frame to show percent change and raw change between test and 
# control groups for KPIs

cleaned_change <- cleaned_summary |>
  select(
    test_group,
    cvr,
    rev_per_session,
    atc_per_session,
    aov,
    nav_clicks_per_session,
    pdps_per_session,
    plps_per_session,
    bounce_rate
  ) |>
  pivot_longer(
    cols = c(
      cvr,
      rev_per_session,
      aov,
      atc_per_session,
      bounce_rate,
      nav_clicks_per_session,
      plps_per_session,
      pdps_per_session
    ),
    names_to = "metric",
    values_to = "value"
  ) |>
  pivot_wider(id_cols = metric, names_from = test_group, values_from = value) |>
  clean_names() |>
  rowwise() |>
  mutate(
    change = (test - control) / mean(c(test, control)),
    raw_change = (test - control)
  )


```

## T-Tests Stratified

```{r}
library(effectsize)
# Conversion Rate
var.test(
  cleaned_strat$purchase[cleaned_strat$test_group == "Control"],
  cleaned_strat$purchase[cleaned_strat$test_group == "Test"]
)

cleaned_strat_cvr_test <- t.test(
  purchase ~ test_group,
  data = cleaned_strat,
  alternative = "two.sided",
  var.equal = FALSE,
  conf.level = 0.95
)

cleaned_strat_cvr_test

cohens_d(purchase ~ test_group,
           data = cleaned_strat)

# Revenue Per Session
var.test(
  cleaned_strat$revenue[cleaned_strat$test_group == "Control"],
  cleaned_strat$revenue[cleaned_strat$test_group == "Test"]
)

cleaned_strat_rev_test <- t.test(
  revenue ~ test_group,
  data = cleaned_strat,
  alternative = "two.sided",
  var.equal = TRUE,
  conf.level = 0.95
)

cleaned_strat_rev_test

cohens_d(revenue ~ test_group,
           data = cleaned_strat)

# Navigation Clicks
var.test(
  cleaned_strat$nav_clicks[cleaned_strat$test_group == "Control"],
  cleaned_strat$nav_clicks[cleaned_strat$test_group == "Test"]
)

cleaned_strat_nav_test <- t.test(
  nav_clicks ~ test_group,
  data = cleaned_strat,
  alternative = "two.sided",
  var.equal = FALSE,
  conf.level = 0.95
)

cleaned_strat_nav_test

cohens_d(nav_clicks ~ test_group,
           data = cleaned_strat)

# Product Views
var.test(
  cleaned_strat$pdp_flag[cleaned_strat$test_group == "Control"],
  cleaned_strat$pdp_flag[cleaned_strat$test_group == "Test"]
)

cleaned_strat_pdp_test <- t.test(
  pdp_flag ~ test_group,
  data = cleaned_strat,
  alternative = "two.sided",
  var.equal = FALSE,
  conf.level = 0.95
)

cleaned_strat_pdp_test

# Bounce Rate
var.test(
  cleaned_strat$bounced_flag[cleaned_strat$test_group == "Control"],
  cleaned_strat$bounced_flag[cleaned_strat$test_group == "Test"]
)

cleaned_strat_bounce_test <- t.test(
  bounced_flag ~ test_group,
  data = cleaned_strat,
  alternative = "two.sided",
  var.equal = FALSE,
  conf.level = 0.95
)

cleaned_strat_bounce_test

cohens_d(bounced_flag ~ test_group,
           data = cleaned_strat)

# Add To Cart
var.test(
  cleaned_strat$add_to_cart[cleaned_strat$test_group == "Control"],
  cleaned_strat$add_to_cart[cleaned_strat$test_group == "Test"]
)

cleaned_strat_add_to_cart <- t.test(
  add_to_cart ~ test_group,
  data = cleaned_strat,
  alternative = "two.sided",
  var.equal = FALSE,
  conf.level = 0.95
)

cleaned_strat_add_to_cart

cohens_d(add_to_cart ~ test_group,
           data = cleaned_strat)
###################################################################################
# List of p-values, Checkout order matches metric order.
###################################################################################

x_mobile <- c(
  cleaned_strat_cvr_test$p.value,
  cleaned_strat_rev_test$p.value,
  cleaned_strat_bounce_test$p.value,
  cleaned_strat_nav_test$p.value,
  cleaned_strat_pdp_test$p.value,
  cleaned_strat_add_to_cart$p.value
)
```

## Metrics Table Stratified

```{r}
result_table_strat <- cleaned_change |> 
  filter(
    metric %in%
      c(
        "cvr",
        "rev_per_session",
        "atc_per_session",
        "bounce_rate",
        "nav_clicks_per_session",
        "pdps_per_session"
      )
  ) |>
  mutate(
    metric = case_when(
      metric == "cvr" ~ "Conversion Rate",
      metric == "rev_per_session" ~ "Revenue/Session",
      metric == "atc_per_session" ~ "ATC/Session",
      metric == "bounce_rate" ~ "Bounce Rate",
      metric == "nav_clicks_per_session" ~ "Nav Clicks/Session",
      metric == "pdps_per_session" ~ "PDP Views/Session",
      TRUE ~ metric
    ),
    control = case_when(
      metric == "Conversion Rate" ~ paste0(round(control, 4) * 100, "%"),
      metric == "Revenue/Session" ~ paste0("$", round(control, 2)),
      metric == "ATC/Session"~ paste0(round(control, 2)),
      metric == "Bounce Rate" ~ paste0(round(control, 4)*100, "%"),
      metric == "Nav Clicks/Session" ~ paste0(round(control, 2)),
      metric == "PDP Views/Session" ~ paste0(round(control, 2)),
      TRUE ~ as.character(control)
    ),
    test = case_when(
      metric == "Conversion Rate" ~ paste0(round(test, 4) * 100, "%"),
      metric == "Revenue/Session" ~ paste0("$", round(test, 2)),
      metric == "ATC/Session"~ paste0(round(test, 2)),
      metric == "Bounce Rate" ~ paste0(round(test, 4)*100, "%"),
      metric == "Nav Clicks/Session" ~ paste0(round(test, 2)),
      metric == "PDP Views/Session" ~ paste0(round(test, 2)),
      TRUE ~ as.character(test)
    ),
    change = percent(change, accuracy = .01)
  ) |>
  cbind(x_mobile) |>
  mutate(
    `Stat Sig. (p < 0.05)` = case_when(x_mobile < 0.05 ~ "Yes", TRUE ~ "No")
  ) |>
  select(-x_mobile)

# Duration
dates <- cleaned_strat |>
  ungroup() |> 
  summarize(
    Test_group = "Experiment Duration",
    n = paste0(
      as.double(difftime(max(date), min(date), units = c("days")) + 1),
      " Days"
    )
  )


n_sessions <- cleaned_strat |>
  ungroup() |> 
  mutate(Test_group = paste0(str_to_title(test_group), " Group")) |>
  group_by(Test_group) |>
  summarize(n = paste0(comma(n_distinct(session_id)), " Sessions"))

desc_table <- rbind(n_sessions, dates)

################################################################################
# Results Kable Table
################################################################################

library(kableExtra)
final_results_strat <- kable_styling(
  kbl(
    select(result_table_strat, -raw_change),
    col.names = c(
      "Metric",
      "Control Group",
      "Test Group",
      "Percent<br/>Difference",
      "Stat Sig.<br/>(p < 0.05)"
    ),
    escape = FALSE,
    align = c("l", "c", "c", "c", "c")
  ),
  full_width = TRUE
)

final_results_strat

################################################################################
# Description Kable Table
################################################################################

final_desc <- kable_styling(
  kbl(desc_table, col.names = c("", ""), align = c("l", "r")),
  full_width = FALSE
)

final_desc
```

# Permutation and bootstrapping data frames Mobile

## Revenue

### Revenue Tables

```{r}
# Test and control revenue lists.

library(reticulate)

test_mobile <- cleaned_strat |>
  filter(test_group == "Test") |>
  select(revenue) |>
  as.list()

test_mobile <- test_mobile[["revenue"]]

control_mobile <- cleaned_strat |>
  filter(test_group == "Control") |>
  select(revenue) |>
  as.list()

control_mobile <- control_mobile[["revenue"]]

```

### Revenue Loop

```{python}
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt

py_test = r.test_mobile
py_control = r.control_mobile


py_bootstrap_results=[]

py_bootstrap_test = []

py_bootstrap_control = []

# Create 1000 simulated experiments with test and control groups 
# drawn from test and control groups of experiment separately.
for i in range(1000):
  bootstrap_control = np.random.choice(py_control, size=len(py_control), replace=True)
  py_bootstrap_control.append(np.mean(bootstrap_control))
  bootstrap_test = np.random.choice(py_test, size=len(py_test), replace=True)
  py_bootstrap_test.append(np.mean(bootstrap_test))
  py_bootstrap_results.append(
    np.mean(bootstrap_test) - np.mean(bootstrap_control)
    )

```

### Revenue Permutation Results

```{r}

# Create data frame from list
permutation_results <- py$py_permutation_results

perm_df <- as.data.frame(unlist(permutation_results)) |>
  rename(rev_difference = `unlist(permutation_results)`)

percent(nrow(perm_df |> filter(rev_difference >= 0)) / nrow(perm_df))

# Create histogram of test - control revenue. Test and control groups treated as 1 population.
# Shows difference in revenue per session of 1000 simulated experiments if there was no difference between test and control.
perm_df |>
  ggplot(aes(rev_difference)) +
  geom_histogram(binwidth = 0.05, fill = "gray", show.legend = FALSE) +
  geom_vline(
    xintercept = tbl_order_percent_change_no_date$raw_change[
      tbl_order_percent_change_no_date$metric == "rev_per_session"
    ],
    color = "red",
    linewidth = 2
  ) +
  labs(
    title = "Difference in Mean Revenue Per Session",
    subtitle = "1000 Trials",
    y = "Frequency",
    x = "Difference in USD",
    caption = "Observed revenue difference shown in red."
  )

# Percent of simulated trials where mean test revenue - mean control revenue was greater than observed result
# multiply by 2 to estimate p-value
nrow(
  perm_df |>
    filter(
      rev_difference >
        tbl_order_percent_change_no_date$raw_change[
          tbl_order_percent_change_no_date$metric == "rev_per_session"
        ]
    )
) /
  nrow(perm_df)
```

### Revenue Bootstrap Results and Confidence Interval

```{r}

# Create data frame from list
bootstrap_results <- py$py_bootstrap_results
bootstrap_test <- py$py_bootstrap_test
bootstrap_control <- py$py_bootstrap_control

bootstrap_df <- as.data.frame(unlist(bootstrap_results)) |>
  rename(rev_difference = `unlist(bootstrap_results)`)

bootstrap_test_df <- as.data.frame(unlist(bootstrap_test)) |>
  rename(revenue = `unlist(bootstrap_test)`)

bootstrap_control_df <- as.data.frame(unlist(bootstrap_control)) |>
  rename(revenue = `unlist(bootstrap_control)`)

# Create histogram of test - control revenue. Test and control groups drawn from separate populations.
bootstrap_df |>
  ggplot(aes(rev_difference)) +
  geom_histogram(
    binwidth = 0.01,
    fill = "#004C97",
    color = "white",
    show.legend = FALSE
  ) +
  geom_vline(
    xintercept = quantile(bootstrap_df$rev_difference, .975),
    color = "red",
    linewidth = 2
  ) +
  geom_vline(
    xintercept = quantile(bootstrap_df$rev_difference, .025),
    color = "red",
    linewidth = 2
  ) +
  labs(
    title = "Difference in Mean Revenue Per Session",
    subtitle = "Test - Control/n1000 Trials",
    y = "Frequency",
    x = "Difference in USD",
    # caption = "95% confidence interval shown in red."
  )

# Show percent of trials where control revenue was higher than test revenue.
paste0(
  percent(
    nrow(bootstrap_df |> filter(rev_difference < 0)) / nrow(bootstrap_df)
  ),
  " Chance of lower average revenue per session with test version."
)

```

### Revenue Test Control Combined

```{r}
# Create dataframes from list and plot histograms

bootstrap_test <- py$py_bootstrap_test
bootstrap_control <- py$py_bootstrap_control

bootstrap_test_df <- as.data.frame(unlist(bootstrap_test)) |>
  rename(revenue = `unlist(bootstrap_test)`)

bootstrap_control_df <- as.data.frame(unlist(bootstrap_control)) |>
  rename(revenue = `unlist(bootstrap_control)`)

bootstrap_test_df |>
  ggplot(aes(revenue)) +
  geom_histogram(
    binwidth = 0.001,
    fill = "#004C97",
    show.legend = TRUE,
    alpha = 0.7
  ) +
  geom_histogram(
    data = bootstrap_control_df,
    binwidth = 0.001,
    fill = "gray",
    show.legend = TRUE,
    alpha = 0.7
  ) +
  labs(
    title = "Test vs Control Revenue Per Session",
    subtitle = "1000 Trials",
    y = "Frequency",
    x = "USD"
  )

```

## Transactions

### Transacton Tables

```{r}
# test, control and combined lists

test_p_mobile <- cleaned_strat |>
  filter(test_group == "Test", device == "Mobile") |>
  select(purchase) |>
  as.list()

test_p_mobile <- test_p_mobile[["purchase"]]

control_p_mobile <- cleaned_strat |>
  filter(test_group == "Control", device == "Mobile") |>
  select(purchase) |>
  as.list()

control_p_mobile <- control_p_mobile[["purchase"]]

combined_p_mobile <- cleaned_strat |>
  filter(device == "Mobile") |>
  select(purchase) |>
  as.list()

combined_p_mobile <- combined_p_mobile[["purchase"]]
```

```{python}
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt

py_combined = r.combined_p_mobile
py_test = r.test_p_mobile
py_control = r.control_p_mobile

# py_permutation_results = []

# Create 1000 simulated experiments with test and control groups drawn from 1 population.
# Drawn from combined experiment results.
# for i in range(1000):
#   combined = np.random.permutation(py_combined)
#   permutation_test = combined[:len(py_test)]
#   permutation_control = combined[-len(py_control):]
#   py_permutation_results.append(
#     np.mean(permutation_test) - np.mean(permutation_control)
    # )

py_bootstrap_results=[]

py_bootstrap_test = []

py_bootstrap_control = []

# Create 1000 simulated experiments with test and control groups drawn from different populations.
# Drawn from test and control groups of experiment separately.
for i in range(1000):
  bootstrap_control = np.random.choice(py_control, size=len(py_control), replace=True)
  py_bootstrap_control.append(np.mean(bootstrap_control))
  bootstrap_test = np.random.choice(py_test, size=len(py_test), replace=True)
  py_bootstrap_test.append(np.mean(bootstrap_test))
  py_bootstrap_results.append(
    np.mean(bootstrap_test) - np.mean(bootstrap_control)
    )

```

### Transaction Permutation Results

```{r}
library(reticulate)
# Create data frame from list
permutation_results_p <- py$py_permutation_results_p

perm_df_p <- as.data.frame(unlist(permutation_results_p)) |>
  rename(purchases = `unlist(permutation_results_p)`)

percent(nrow(perm_df_p |> filter(purchases >= 0)) / nrow(perm_df_p))

# Create histogram of test - control revenue. Test and control groups treated as 1 population.
# Shows difference in revenue per session of 1000 simulated experiments if there was no difference between test and control.
perm_df_p |>
  ggplot(aes(purchases)) +
  geom_histogram(binwidth = 0.001, fill = "gray", show.legend = FALSE) +
  geom_vline(
    xintercept = tbl_order_percent_change_no_date$raw_change[
      tbl_order_percent_change_no_date$metric == "purchases"
    ],
    color = "red",
    linewidth = 2
  ) +
  labs(
    title = "Difference in Mean Revenue Per Session",
    subtitle = "1000 Trials",
    y = "Frequency",
    x = "Difference in USD",
    caption = "Observed revenue difference shown in red."
  )

# Percent of simulated trials where mean test revenue - mean control revenue was greater than observed result
# multiply by 2 to estimate p-value
nrow(
  perm_df |>
    filter(
      rev_difference >
        tbl_order_percent_change_no_date$raw_change[
          tbl_order_percent_change_no_date$metric == "rev_per_session"
        ]
    )
) /
  nrow(perm_df)
```

### Revenue Bootstrap Results and Confidence Interval

```{r}
library(reticulate)
# Create data frame from list
bootstrap_results <- py$py_bootstrap_results
bootstrap_test <- py$py_bootstrap_test
bootstrap_control <- py$py_bootstrap_control

bootstrap_df <- as.data.frame(unlist(bootstrap_results)) |>
  rename(purchase_dif = `unlist(bootstrap_results)`)

bootstrap_test_df <- as.data.frame(unlist(bootstrap_test)) |>
  rename(purchase = `unlist(bootstrap_test)`)

bootstrap_control_df <- as.data.frame(unlist(bootstrap_control)) |>
  rename(purchase = `unlist(bootstrap_control)`)

# Create histogram of test - control revenue. Test and control groups drawn from separate populations.
bootstrap_df |>
  ggplot(aes(purchase_dif)) +
  geom_histogram(
    binwidth = 0.0001,
    fill = "#004C97",
    color = "white",
    show.legend = FALSE
  ) +
  geom_vline(
    xintercept = quantile(bootstrap_df$rev_difference, .975),
    color = "red",
    linewidth = 2
  ) +
  geom_vline(
    xintercept = quantile(bootstrap_df$rev_difference, .025),
    color = "red",
    linewidth = 2
  ) +
  labs(
    title = "Difference in Conversion rate (Test - Control)",
    subtitle = "Test - Control/n1000 Trials",
    y = "Frequency",
    x = "Difference in Conversion Rate",
    # caption = "95% confidence interval shown in red."
  )

# Show percent of trials where control revenue was higher than test revenue.
# paste0(percent(nrow(bootstrap_df |> filter(purchase_dif < 0))/nrow(bootstrap_df))," Chance of lower average revenue per session with test version.")
```

### Revenue Test Control Combined

```{r}
bootstrap_test_df |>
  ggplot(aes(purchase)) +
  geom_histogram(
    binwidth = 0.00001,
    fill = "#004C97",
    show.legend = TRUE,
    alpha = 0.7
  ) +
  geom_histogram(
    data = bootstrap_control_df,
    binwidth = 0.00001,
    fill = "gray",
    show.legend = TRUE,
    alpha = 0.7
  ) +

  scale_x_continuous(label = percent) +
  labs(
    title = "Test vs Control CVR",
    subtitle = "1000 Trials",
    y = "Frequency",
    x = "Conversion Rate"
  )

```

# Stratified Sampling 2
```{r}
# Check distribution of channels and landing page categories

cleaned_df |>
  filter(tracking_consent == 1) |>
  group_by(test_group, 
           landing_page_cat) |>
  summarize(
    sessions = n_distinct(session_id),
    cvr = sum(purchase) / sessions
  ) |>
  ggplot(aes(reorder(landing_page_cat, sessions), sessions, fill = test_group), ) +
  scale_y_continuous(labels = comma) +
  geom_col(position = "dodge") +
  scale_fill_vf(palette = "two") +
  coord_flip() +
  labs(x = "Landing Page",
       y = "Sessions",
       fill = NULL)

# Create data fram with total counts of sessions for each landing page 
# category by test group and a column with the minumum number of sessionsf
# for each landing page category between test and control.

sessions <- cleaned_df |>
  group_by(test_group, 
           landing_page_cat) |>
  summarize(
    sessions = n_distinct(session_id),
    cvr = sum(purchase) / sessions
  ) |>
  pivot_wider(
    id_cols =  landing_page_cat,
    names_from = test_group,
    values_from = sessions
  ) |>
  rowwise() |>
  mutate(percent_dif = (Test - Control) / mean(c(Test, Control))) |>
  arrange(desc(percent_dif)) |>
  rowwise() |>
  mutate(min = min(c(Control, Test)))

# Join the minimum session counts column to the original data frame
# Resample test and control groups so that each test group/landing page 
# combination has an equal number of observations. Equal to the minimum session
# counts between test and control.

set.seed(105)
cleaned_strat <- cleaned_df |>
  left_join(sessions |> select(landing_page_cat, min), by = "landing_page_cat") |>
  filter(channel != "Mobile Push Notifications") |> 
  group_by(test_group,landing_page_cat) |>
  sample_n(min(min))|> 
  mutate(test_group = factor(test_group),
         purchase = as.numeric(purchase))

# Chart to check that session counts by landing page are equal between test
# and control

cleaned_strat |>
  group_by(landing_page_cat, test_group) |>
  summarize(sessions = n_distinct(session_id))|> 
  ggplot(aes(reorder(landing_page_cat, sessions), sessions, fill = test_group), ) +
  scale_y_continuous(labels = comma) +
  geom_col(position = "dodge") +
  scale_fill_vf(palette = "two") +
  coord_flip() +
  labs(x = NULL,
       y = "Sessions",
       fill = NULL)

# Summarize test and control groups

cleaned_strat_summary <- cleaned_strat |>
  filter(tracking_consent == 1) |>
  group_by(test_group, ) |>
  summarize(
    sessions = n_distinct(session_id),
    added_to_cart = sum(add_to_cart),
    purchases = sum(purchase, na.rm = TRUE),
    purchase_quantity = sum(quantity, na.rm = TRUE),
    total_revenue = sum(revenue, na.rm = TRUE),
    plp_views = sum(plp_flag),
    pdp_views = sum(pdp_flag),
    nav_clicks = sum(nav_clicks),
    bounced_sessions = sum(bounced_flag)
  ) |>
  mutate(
    cvr = purchases / sessions,
    atc_per_session = added_to_cart / sessions,
    aov = total_revenue / purchases,
    items_per_transaction = purchase_quantity / purchases,
    rev_per_session = total_revenue / sessions,
    nav_clicks_per_session = nav_clicks / sessions,
    plps_per_session = plp_views / sessions,
    pdps_per_session = pdp_views / sessions,
    bounce_rate = bounced_sessions / sessions,
    test_group = factor(test_group, levels = c("Test", "Control"))
  )

# Create data frame to show percent change and raw change between test and 
# control groups for KPIs

vans_change_strat <- cleaned_strat_summary |>
  select(
    test_group,
    cvr,
    rev_per_session,
    aov,
    nav_clicks_per_session,
    pdps_per_session,
    plps_per_session,
    bounce_rate
  ) |>
  pivot_longer(
    cols = c(
      cvr,
      rev_per_session,
      aov,
      bounce_rate,
      nav_clicks_per_session,
      plps_per_session,
      pdps_per_session
    ),
    names_to = "metric",
    values_to = "value"
  ) |>
  pivot_wider(id_cols = metric, names_from = test_group, values_from = value) |>
  clean_names() |>
  rowwise() |>
  mutate(
    change = (test - control) / mean(c(test, control)),
    raw_change = (test - control)
  )

```

